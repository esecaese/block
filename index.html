<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLOCK #somosblock</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BLOCK. Comp">
    
    <link rel="icon" id="dynamic-favicon">
    <link rel="apple-touch-icon" id="dynamic-apple-icon">
    <link rel="manifest" id="dynamic-manifest">

    <script src="logos.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #3b82f6; --success: #22c55e; --danger: #ef4444;
            --bg-dark: #0f172a; --bg-card: #1e293b; --bg-input: #334155;
            --text-main: #f8fafc; --text-muted: #94a3b8; --gold: #fbbf24;
            --border: #334155;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 0; background: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; user-select: none; }
        .hidden { display: none !important; } .text-center { text-align: center; } .w-full { width: 100%; }

        /* --- SELECTOR --- */
        #selector { position: absolute; top:0; left:0; width:100%; height:100%; z-index:999; background: #000; display: flex; justify-content: center; align-items: center; gap: 20px; }
        .mode-btn { padding: 20px 40px; font-size: 1.5rem; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: transform 0.2s; }
        .mode-btn:hover { transform: scale(1.05); }
        .selector-footer { position: absolute; bottom: 30px; width: 100%; text-align: center; }

        /* --- OPERADOR --- */
        #operator-view { background: var(--bg-dark); height: 100%; overflow-y: auto; padding: 15px; padding-bottom: 70px; box-sizing: border-box; position: relative; }
        
        input, select { background: var(--bg-input); color: white; border: 1px solid var(--border); padding: 12px; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 1.1rem; }
        input:focus, select:focus { outline: 2px solid var(--primary); border-color: transparent; }

        .btn-add { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-start { background: var(--success); color: white; padding: 15px; width: 100%; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 8px; margin-top: 20px; cursor: pointer; }
        .btn-reset { background: #333; color: #aaa; border: 1px solid #444; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        .op-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); }
        .reg-list { list-style: none; padding: 0; margin-top: 20px; }
        .reg-item { background: var(--bg-input); padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }

        .lifter-highlight { border: 2px solid var(--primary); background: #1e3a8a; text-align: center; }
        .big-name { font-size: 1.8rem; font-weight: 800; margin: 0; color: white; }
        .big-weight { font-size: 3rem; font-weight: 900; color: var(--gold); margin: 5px 0; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-lg { padding: 20px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 8px; color: white; cursor: pointer; }
        .btn-good { background: var(--success); color: #000; }
        .btn-bad { background: var(--danger); color: #fff; }
        .queue-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border); color: var(--text-muted); }
        .queue-item strong { color: var(--gold); }

        .op-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card); padding: 10px; border-top: 1px solid var(--border); z-index: 100; }
        .footer-container { display: flex; justify-content: center; align-items: center; gap: 12px; color: var(--text-muted); font-weight: bold; }
        .footer-logo { max-height: 30px; width: auto; opacity: 0.9; }

        /* --- TV --- */
        #tv-view { background: #000; color: var(--text-main); display: grid; grid-template-columns: 1fr 1fr 1.2fr; grid-template-rows: 1fr auto; height: 100vh; box-sizing: border-box; position: relative; }
        .tv-col { border-right: 2px solid var(--border); display: flex; flex-direction: column; overflow: hidden; background: var(--bg-dark); }
        .tv-col:last-child { border-right: none; background: #020617; }
        .tv-header { background: var(--bg-card); padding: 15px; text-align: center; font-size: 1.8rem; font-weight: bold; text-transform: uppercase; color: var(--text-muted); border-bottom: 2px solid var(--border); }
        .rank-list { padding: 10px; }
        .rank-row { display: flex; justify-content: space-between; padding: 15px 10px; border-bottom: 1px solid var(--border); font-size: 1.5rem; align-items: center; }
        .rank-pos { color: var(--text-muted); font-weight: bold; width: 40px; }
        .rank-name { flex: 1; font-weight: 600; }
        .rank-val { color: var(--gold); font-weight: bold; }
        .stage-active { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: var(--bg-card); margin: 10px; border-radius: 10px; border: 2px solid var(--gold); position: relative; }
        .stage-label { font-size: 1.5rem; color: var(--text-muted); margin-bottom: 10px; letter-spacing: 2px; }
        .stage-name { font-size: 3.5rem; font-weight: 900; line-height: 1.1; text-align: center; margin: 0; color: #fff; text-transform: uppercase; }
        .stage-weight { font-size: 6rem; font-weight: bold; color: var(--gold); line-height: 1; margin: 10px 0; }
        .queue-row { display: flex; justify-content: space-between; font-size: 1.4rem; padding: 10px; border-bottom: 1px solid var(--border); color: var(--text-muted); }
        .tv-footer { grid-column: 1 / -1; background: #020617; padding: 15px; border-top: 2px solid var(--border); }
        .tv-footer .footer-logo { max-height: 40px; }
        .tv-footer .footer-container { font-size: 1.2rem; }

        /* --- NUEVO MODAL ESTILO CALCULADORA --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--bg-card); padding: 20px; border-radius: 12px; width: 95%; max-width: 450px; text-align: center; border: 1px solid var(--border); }
        
        /* Display Digital */
        .weight-display-container {
            background: #000; border: 2px solid var(--primary); border-radius: 8px; margin: 15px 0; padding: 15px;
        }
        .weight-display-val { font-size: 4rem; font-weight: 900; color: var(--gold); line-height: 1; display: block;}
        .weight-display-lbl { font-size: 1rem; color: #666; text-transform: uppercase; letter-spacing: 2px; }

        /* Grilla de Botones */
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        
        .btn-calc { 
            padding: 15px 5px; font-size: 1.3rem; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; color: white;
            display: flex; justify-content: center; align-items: center;
        }
        .btn-plus { background: #334155; border: 1px solid #475569; }
        .btn-plus:active { background: var(--success); transform: scale(0.95); }
        
        .btn-minus { background: #1e293b; border: 1px solid #334155; color: #ef4444; }
        .btn-minus:active { background: #ef4444; color: white; transform: scale(0.95); }
        .btn-minus:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Texto informativo */
        .modal-info { color: var(--text-muted); margin-bottom: 5px; font-size: 1.1rem; }
    </style>
</head>
<body>

    <div id="selector">
        <button class="mode-btn" onclick="initMode('tv')" style="background: var(--gold); color: black;">ðŸ“º MODO TV</button>
        <button class="mode-btn" onclick="initMode('op')" style="background: #333; color: white; border: 1px solid #555;">ðŸ“± MODO OPERADOR</button>
        <div class="selector-footer">
            <div class="footer-container">
                <img id="selector-footer-logo" class="footer-logo" src="" alt="BLOCK." style="display:none">
                <span>#<span style="color:var(--gold)">somosblock</span></span>
            </div>
        </div>
    </div>

    <div id="operator-view" class="hidden">
        <div id="phase-registration" style="margin-top: 10px;">
            <h2 class="text-center" style="margin-top:0;">ðŸ“‹ Registro de Atletas</h2>
            <div class="op-card">
                <div style="display:grid; gap:10px;">
                    <input type="text" id="reg-name" placeholder="Nombre del Atleta">
                    <select id="reg-gender">
                        <option value="M">Hombre</option>
                        <option value="F">Mujer</option>
                    </select>
                    <input type="number" id="reg-weight" placeholder="Peso Inicial (kg)">
                    <button class="btn-add" onclick="addLifter()">+ AÃ‘ADIR</button>
                </div>
            </div>
            <div class="op-card">
                <h4 style="margin-top:0;">Inscritos (<span id="count-lifters" style="color:var(--primary)">0</span>)</h4>
                <ul id="list-registered" class="reg-list"></ul>
            </div>
            <button class="btn-start" onclick="startCompetition()">ðŸš€ INICIAR</button>
        </div>

        <div id="phase-competition" class="hidden" style="margin-top: 10px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0; color:var(--text-muted);">Control de Tarima</h3>
                <button class="btn-reset" onclick="hardReset()">Reset Total</button>
            </div>
            <div id="active-card" class="op-card lifter-highlight hidden">
                <span style="background:var(--bg-dark); color:var(--text-muted); padding:2px 8px; border-radius:4px; font-size:0.8rem; border:1px solid var(--border);" id="op-attempt-info">Intento 1</span>
                <h2 class="big-name" id="op-name">Nombre</h2>
                <h1 class="big-weight" id="op-weight">00 kg</h1>
                <div class="btn-group">
                    <button class="btn-lg btn-good" onclick="handleResult(true)">LOGRADO</button>
                    <button class="btn-lg btn-bad" onclick="handleResult(false)">NO LOGRADO</button>
                </div>
            </div>
            <div id="no-active-msg" class="op-card text-center hidden">
                <h3>Competencia Finalizada</h3>
                <p style="color:var(--text-muted);">Todos los atletas han completado sus intentos.</p>
            </div>
            <div class="op-card">
                <h4 style="margin-top:0; color:var(--text-muted);">Siguientes:</h4>
                <div id="op-queue-list"></div>
            </div>
        </div>

        <div class="op-footer">
            <div class="footer-container">
                <img id="op-footer-logo" class="footer-logo" src="" alt="BLOCK." style="display:none">
                <span>#<span style="color:var(--gold)">somosblock</span></span>
            </div>
        </div>
    </div>

    <div id="tv-view" class="hidden">
        <div class="tv-col">
            <div class="tv-header" style="color:#60a5fa; border-bottom-color:#1e3a8a;">Ranking Hombres</div>
            <div id="tv-rank-m" class="rank-list"></div>
        </div>
        <div class="tv-col">
            <div class="tv-header" style="color:#f472b6; border-bottom-color:#831843;">Ranking Mujeres</div>
            <div id="tv-rank-f" class="rank-list"></div>
        </div>
        <div class="tv-col">
            <div class="tv-header" style="color:var(--gold);">En Tarima</div>
            <div id="tv-stage-area" class="stage-active hidden">
                <div class="stage-label" id="tv-attempt-label">INTENTO 1</div>
                <div class="stage-name" id="tv-active-name">NOMBRE</div>
                <div class="stage-weight"><span id="tv-active-weight">00</span>kg</div>
            </div>
            <div id="tv-stage-empty" class="stage-active hidden" style="border-color:#333;">
                <div class="stage-label">ESTADO</div>
                <div class="stage-name" style="color:#666;">ESPERANDO</div>
            </div>
            <div style="background:var(--bg-dark); padding:10px; border-top:2px solid var(--border); flex:1;">
                <div style="color:var(--text-muted); font-weight:bold; margin-bottom:10px; font-size:0.9rem;">PRÃ“XIMOS ATLETAS:</div>
                <div id="tv-queue-list"></div>
            </div>
        </div>
        <div class="tv-footer">
            <div class="footer-container">
                <img id="tv-footer-logo" class="footer-logo" src="" alt="BLOCK." style="display:none">
                <span>#<span style="color:var(--gold)">somosblock</span></span>
            </div>
        </div>
    </div>

    <div id="modal-next-weight" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 style="margin-top:0; color:white;">PrÃ³ximo Intento</h3>
            <p class="modal-info">Atleta: <strong><span id="mod-lifter-name" style="color:white;"></span></strong></p>
            
            <div class="weight-display-container">
                <span id="display-val" class="weight-display-val">0</span>
                <span class="weight-display-lbl">KILOGRAMOS</span>
            </div>
            
            <p class="modal-info" style="font-size:0.9rem;">MÃ­nimo permitido: <span id="mod-last-weight-display">0</span>kg</p>

            <div class="calc-grid">
                <button class="btn-calc btn-plus" onclick="modifyWeight(1)">+1</button>
                <button class="btn-calc btn-plus" onclick="modifyWeight(2)">+2</button>
                <button class="btn-calc btn-plus" onclick="modifyWeight(5)">+5</button>
                <button class="btn-calc btn-plus" onclick="modifyWeight(10)">+10</button>
                
                <button class="btn-calc btn-minus" onclick="modifyWeight(-1)">-1</button>
                <button class="btn-calc btn-minus" onclick="modifyWeight(-2)">-2</button>
                <button class="btn-calc btn-minus" onclick="modifyWeight(-5)">-5</button>
                <button class="btn-calc btn-minus" onclick="modifyWeight(-10)">-10</button>
            </div>

            <button class="btn-start" onclick="confirmNextWeight()">CONFIRMAR PESO</button>
        </div>
    </div>

    <script>
        // === FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyC5EofUY8AfUeXo6bsQvxp7V2Rl4_w7r-0",
            authDomain: "blocksomosblock.firebaseapp.com",
            databaseURL: "https://blocksomosblock-default-rtdb.firebaseio.com",
            projectId: "blocksomosblock",
            storageBucket: "blocksomosblock.firebasestorage.app",
            messagingSenderId: "245171878208",
            appId: "1:245171878208:web:4dee166bb5eb4ade9162a5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let localData = { athletes: [], started: false };

        db.ref('competition').on('value', (snapshot) => {
            const val = snapshot.val();
            if (val) {
                localData = val;
                if(!localData.athletes) localData.athletes = [];
            } else {
                localData = { athletes: [], started: false };
            }
            renderAll();
        });

        // === CARGA DE LOGOS ===
        window.addEventListener('load', () => {
            if (typeof MIS_LOGOS !== 'undefined') {
                const srcLogo = MIS_LOGOS.visual;
                const srcIcon = MIS_LOGOS.icon;
                if(srcLogo) {
                    [document.getElementById('op-footer-logo'), document.getElementById('tv-footer-logo'), document.getElementById('selector-footer-logo')]
                    .forEach(l => { if(l) { l.src = srcLogo; l.style.display = 'block'; } });
                }
                if(srcIcon) {
                    document.getElementById('dynamic-favicon').href = srcIcon;
                    document.getElementById('dynamic-apple-icon').href = srcIcon;
                    const manifest = { "name": "BLOCK.", "short_name": "BLOCK.", "start_url": ".", "display": "standalone", "background_color": "#0f172a", "theme_color": "#0f172a", "icons": [{"src": srcIcon, "sizes": "192x192", "type": "image/png"}] };
                    const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
                    document.getElementById('dynamic-manifest').setAttribute('href', URL.createObjectURL(blob));
                }
            }
        });

        // === LÃ“GICA ===
        function updateCloud() { db.ref('competition').set(localData); }

        function initMode(mode) {
            document.getElementById('selector').classList.add('hidden');
            if (mode === 'tv') document.getElementById('tv-view').classList.remove('hidden');
            else document.getElementById('operator-view').classList.remove('hidden');
            renderAll();
        }

        function addLifter() {
            const name = document.getElementById('reg-name').value;
            const weight = parseInt(document.getElementById('reg-weight').value);
            const gender = document.getElementById('reg-gender').value;
            if (!name || !weight) return alert("Faltan datos");
            localData.athletes.push({
                id: Date.now(), name, gender,
                attempts: [{ weight: weight, status: 'pending' }, { weight: null, status: 'pending' }, { weight: null, status: 'pending' }],
                currentAttemptIndex: 0, bestLift: 0, finished: false
            });
            updateCloud();
            document.getElementById('reg-name').value = '';
            document.getElementById('reg-weight').value = '';
            document.getElementById('reg-name').focus();
        }

        function startCompetition() {
            if (localData.athletes.length === 0) return alert("Registra al menos un atleta");
            if (confirm("Â¿Comenzar competencia?")) { localData.started = true; updateCloud(); }
        }

        function hardReset() {
            if (confirm("âš ï¸ Â¿BORRAR TODO?")) { db.ref('competition').set(null); location.reload(); }
        }

        function getSortedQueue() {
            if(!localData.athletes) return [];
            let active = localData.athletes.filter(l => !l.finished);
            return active.sort((a, b) => {
                const wA = a.attempts[a.currentAttemptIndex].weight;
                const wB = b.attempts[b.currentAttemptIndex].weight;
                if (wA !== wB) return wA - wB; 
                if (a.currentAttemptIndex !== b.currentAttemptIndex) return a.currentAttemptIndex - b.currentAttemptIndex;
                return a.id - b.id;
            });
        }

        // === VARIABLES MODAL CALCULADORA ===
        let tempLifterId = null;
        let minAllowedWeight = 0; // El peso minimo (del intento anterior)
        let currentModalWeight = 0; // El peso que se muestra en pantalla gigante

        function handleResult(isGood) {
            const queue = getSortedQueue();
            if (queue.length === 0) return;
            const lifter = localData.athletes.find(l => l.id === queue[0].id);
            const idx = lifter.currentAttemptIndex;
            const currentWeight = lifter.attempts[idx].weight;
            
            lifter.attempts[idx].status = isGood ? 'good' : 'bad';
            if (isGood && currentWeight > lifter.bestLift) lifter.bestLift = currentWeight;
            
            if (idx >= 2) {
                lifter.finished = true; updateCloud();
            } else {
                // Preparamos datos para el modal
                tempLifterId = lifter.id;
                minAllowedWeight = currentWeight; // Regla: no bajar del peso actual
                
                // Abrimos modal iniciandolo con el mismo peso
                updateCloud(); // Guardar el resultado parcial antes de abrir
                openNextWeightModal(lifter.name, minAllowedWeight);
            }
        }

        function openNextWeightModal(name, startWeight) {
            document.getElementById('modal-next-weight').classList.remove('hidden');
            document.getElementById('mod-lifter-name').innerText = name;
            document.getElementById('mod-last-weight-display').innerText = startWeight;
            
            // Iniciar variables de la calculadora
            currentModalWeight = startWeight;
            updateWeightDisplay();
        }

        function modifyWeight(amount) {
            const newVal = currentModalWeight + amount;
            // VALIDACIÃ“N: No permitir bajar del mÃ­nimo
            if (newVal < minAllowedWeight) return; 
            
            currentModalWeight = newVal;
            updateWeightDisplay();
        }

        function updateWeightDisplay() {
            document.getElementById('display-val').innerText = currentModalWeight;
            
            // Deshabilitar visualmente botones de resta si estamos en el limite
            const minusBtns = document.querySelectorAll('.btn-minus');
            minusBtns.forEach(btn => {
                // Miramos el valor del botÃ³n (ej -1, -5)
                // Obtenemos el numero del onclick attribute es un poco hacky, mejor logica directa:
                // Simplemente si current <= minAllowed, deshabilitamos todos los minus por estÃ©tica
                if (currentModalWeight <= minAllowedWeight) btn.disabled = true;
                else btn.disabled = false;
            });
        }

        function confirmNextWeight() {
            // Ya tenemos currentModalWeight validado
            const lifter = localData.athletes.find(l => l.id === tempLifterId);
            lifter.currentAttemptIndex++;
            lifter.attempts[lifter.currentAttemptIndex].weight = currentModalWeight;
            updateCloud();
            document.getElementById('modal-next-weight').classList.add('hidden');
        }

        // === RENDER ===
        function renderAll() {
            const opView = !document.getElementById('operator-view').classList.contains('hidden');
            const tvView = !document.getElementById('tv-view').classList.contains('hidden');
            if (opView) refreshOperatorUI();
            if (tvView) renderTV();
        }

        function refreshOperatorUI() {
            const regDiv = document.getElementById('phase-registration');
            const compDiv = document.getElementById('phase-competition');
            if (!localData.started) {
                regDiv.classList.remove('hidden'); compDiv.classList.add('hidden');
                renderRegistrationList();
            } else {
                regDiv.classList.add('hidden'); compDiv.classList.remove('hidden');
                renderCompetitionOperator();
            }
        }

        function renderRegistrationList() {
            const list = localData.athletes || [];
            document.getElementById('count-lifters').innerText = list.length;
            document.getElementById('list-registered').innerHTML = list.map(l => `
                <li class="reg-item"><span><b>${l.name}</b> (${l.gender})</span><span style="color:var(--gold)">${l.attempts[0].weight}kg</span></li>
            `).join('');
        }

        function renderCompetitionOperator() {
            const queue = getSortedQueue();
            const activeCard = document.getElementById('active-card');
            const noActiveMsg = document.getElementById('no-active-msg');
            const queueList = document.getElementById('op-queue-list');
            if (queue.length > 0) {
                activeCard.classList.remove('hidden'); noActiveMsg.classList.add('hidden');
                const current = queue[0];
                document.getElementById('op-name').innerText = current.name;
                document.getElementById('op-weight').innerText = current.attempts[current.currentAttemptIndex].weight + ' kg';
                document.getElementById('op-attempt-info').innerText = `INTENTO ${current.currentAttemptIndex + 1}`;
                queueList.innerHTML = queue.slice(1).map(l => `
                    <div class="queue-item"><span>${l.name}</span><strong>${l.attempts[l.currentAttemptIndex].weight} kg</strong></div>
                `).join('');
            } else {
                activeCard.classList.add('hidden'); noActiveMsg.classList.remove('hidden');
                queueList.innerHTML = '<p style="text-align:center; color:#666;">No hay atletas pendientes.</p>';
            }
        }

        function renderTV() {
            const list = localData.athletes || [];
            const sortedBest = [...list].sort((a,b) => b.bestLift - a.bestLift);
            const renderRank = (arr) => arr.map((l, i) => `
                <div class="rank-row"><span class="rank-pos">${i+1}</span><span class="rank-name">${l.name}</span><span class="rank-val">${l.bestLift > 0 ? l.bestLift : '-'}</span></div>
            `).join('');
            document.getElementById('tv-rank-m').innerHTML = renderRank(sortedBest.filter(l => l.gender === 'M'));
            document.getElementById('tv-rank-f').innerHTML = renderRank(sortedBest.filter(l => l.gender === 'F'));
            const stageArea = document.getElementById('tv-stage-area');
            const stageEmpty = document.getElementById('tv-stage-empty');
            const queueList = document.getElementById('tv-queue-list');
            if (!localData.started) {
                stageArea.classList.add('hidden'); stageEmpty.classList.remove('hidden');
                stageEmpty.querySelector('.stage-name').innerText = "REGISTRO";
                queueList.innerHTML = "<div style='text-align:center; color:#666; padding:20px;'>Esperando inicio...</div>";
                return;
            }
            const queue = getSortedQueue();
            if (queue.length > 0) {
                const current = queue[0];
                stageArea.classList.remove('hidden'); stageEmpty.classList.add('hidden');
                document.getElementById('tv-active-name').innerText = current.name;
                document.getElementById('tv-active-weight').innerText = current.attempts[current.currentAttemptIndex].weight;
                document.getElementById('tv-attempt-label').innerText = `INTENTO ${current.currentAttemptIndex + 1}`;
                queueList.innerHTML = queue.slice(1, 6).map(l => `
                    <div class="queue-row"><span>${l.name}</span><span style="color:#fbbf24">${l.attempts[l.currentAttemptIndex].weight}</span></div>
                `).join('');
            } else {
                stageArea.classList.add('hidden'); stageEmpty.classList.remove('hidden');
                stageEmpty.querySelector('.stage-name').innerText = "FINALIZADO";
                queueList.innerHTML = "";
            }
        }
    </script>
</body>
</html>
